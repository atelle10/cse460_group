{% extends 'base.html' %}

{% block title %}{{ event.title }} - SunDevil Connect{% endblock %}

{% block content %}

<div class="club-detail-wrapper">
    <a href="{% url 'student_home' %}" class="btn btn-secondary">Back to Home</a>
</div>

<div class="club-detail-box">
    <div class="club-header">
        <h2>{{ event.title }}</h2>
    </div>

    <div class="club-description">
        <h3>About</h3>
        <p>{{ event.description }}</p>
    </div>

    <div class="club-details-grid">
        <div class="detail-item">
            <h3>Details</h3>
            <p><strong>Date:</strong> {{ event.start_time|date:"M d, Y" }}</p>
            <p><strong>Time:</strong> {{ event.start_time|date:"g:i A" }} - {{ event.end_time|date:"g:i A" }}</p>
            <p><strong>Location:</strong> {{ event.location }}</p>
            <p><strong>Type:</strong> {% if event.event_type == 'IN_PERSON' %}In Person{% elif event.event_type == 'VIRTUAL' %}Virtual{% else %}{{ event.event_type }}{% endif %}</p>
            {% if event.categories %}
            <p><strong>Categories:</strong> {{ event.categories|join:", " }}</p>
            {% endif %}
        </div>

        <div class="detail-item">
            <h3>Registration</h3>
            <p><strong>Capacity:</strong> {% if event.capacity %}{{ event.registered_count }}/{{ event.capacity }}{% else %}Unlimited{% endif %}</p>
            {% if event.capacity and event.registered_count >= event.capacity %}
                <p class="text-muted">Event is at full capacity</p>
            {% endif %}
        </div>
    </div>

    <div class="detail-item">
        <h3>Club</h3>
        <p><a href="{% url 'club_detail' event.club.club_id %}">{{ event.club.name }}</a></p>
    </div>

    {% if success %}
    <div class="alert alert-success">
        {{ success }}
    </div>
    {% endif %}

    {% if error %}
    <div class="alert alert-error">
        {{ error }}
    </div>
    {% endif %}

    <div class="join-section">
        {% if user_type == 'admin' %}
            <form method="POST" action="{% url 'event_detail' event.event_id %}" onsubmit="return confirm('Are you sure you want to delete this event? This action cannot be undone.');">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete_event">
                <button type="submit" class="btn" style="background-color: #d9534f;">Delete Event</button>
            </form>
            <p class="text-muted" style="margin-top: 10px;">Admin: Delete this event permanently</p>
        {% elif registration_status == 'REGISTERED' %}
            <form method="POST" action="{% url 'event_detail' event.event_id %}">
                {% csrf_token %}
                <input type="hidden" name="action" value="cancel_registration">
                <button type="submit" class="btn btn-secondary">Cancel Registration</button>
            </form>
            <p class="text-muted" style="margin-top: 10px;">You are registered for this event</p>
        {% elif event.status == 'CANCELLED' %}
            <p class="text-muted">This event has been cancelled</p>
        {% elif event.capacity and event.registered_count >= event.capacity %}
            <button class="btn" disabled>Event Full</button>
        {% else %}
            <form method="POST" action="{% url 'event_detail' event.event_id %}">
                {% csrf_token %}
                <input type="hidden" name="action" value="register">
                <button type="submit" class="btn">Register for Event</button>
            </form>
        {% endif %}
    </div>

    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
        <details>
            <summary style="cursor: pointer; color: #666; font-size: 0.9em;">Report an issue with this event</summary>
            <form method="POST" action="{% url 'event_detail' event.event_id %}" style="margin-top: 10px;">
                {% csrf_token %}
                <input type="hidden" name="action" value="flag_event">
                <div class="form-group">
                    <label for="flag_reason">Reason for reporting:</label>
                    <textarea id="flag_reason" name="reason" rows="3" placeholder="Please describe the issue..." required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                </div>
                <button type="submit" class="btn btn-secondary" style="padding: 8px 16px;">Submit Report</button>
            </form>
        </details>
    </div>
</div>

<div class="club-detail-box" style="margin-top: 20px;">
    <h3>Registered Members ({{ registered_members|length }})</h3>
    {% if registered_members %}
        <div class="members-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
            {% for registration in registered_members %}
                <div class="member-item" style="padding: 8px; border-bottom: 1px solid #eee;">
                    <p style="margin: 0;"><strong>{{ registration.student.first_name }} {{ registration.student.last_name }}</strong></p>
                    <p class="text-muted" style="margin: 0; font-size: 0.9em;">
                        {{ registration.student.major|default:"No major listed" }} - Registered {{ registration.registered_at|date:"M d, Y" }}
                    </p>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-muted">No registered members yet.</p>
    {% endif %}
</div>

{% endblock %}
